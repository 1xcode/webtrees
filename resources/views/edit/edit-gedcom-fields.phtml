<?php

use Fisharebest\Webtrees\Elements\EmptyElement;
use Fisharebest\Webtrees\Registry;
use Fisharebest\Webtrees\Tree;
use Ramsey\Uuid\Uuid;

/**
 * @var string        $gedcom
 * @var array<string> $hierarchy
 * @var string        $prefix
 * @var Tree          $tree
 */

preg_match_all('/^(\d+) (\w+) ?(.*)/m', $gedcom, $matches);
[, $levels, $tags, $values] = $matches;
$levels   = array_map(static fn(string $x): int => (int) $x, $levels);
$keys     = array_keys($levels);
$elements = [];
$ids      = [];

foreach ($keys as $key) {
    $hierarchy[$levels[$key]] = $tags[$key];
    $full_tag                 = implode(':', array_slice($hierarchy, 0, 1 + $levels[$key]));
    $elements[$key]           = Registry::elementFactory()->make($full_tag);
    $ids[$key]                = Uuid::uuid4()->toString() . '-' . $full_tag;
}

?>
<?php foreach ($keys as $key) : ?>
    <?php if ($elements[$key] instanceof EmptyElement && $values[$key] === '') : ?>
        <input type="hidden" name="<?= e($prefix) ?>levels[]" value="<?= $levels[$key] ?>">
        <input type="hidden" name="<?= e($prefix) ?>tags[]" value="<?= e($tags[$key]) ?>">
        <input type="hidden" name="<?= e($prefix) ?>values[]" value="">
    <?php else : ?>
        <div class="row form-group mb-3">
            <label class="col-sm-3 col-form-label" for="<?= e($ids[$key]) ?>">
                <?= $elements[$key]->label() ?>
            </label>

            <div class="col-sm-9">
                <input type="hidden" name="<?= e($prefix) ?>levels[]" value="<?= $levels[$key] ?>">
                <input type="hidden" name="<?= e($prefix) ?>tags[]" value="<?= e($tags[$key]) ?>">
                <?= $elements[$key]->edit($ids[$key], $prefix . 'values[]', strtr($values[$key], ["\r" => "\n"]), $tree) ?>
            </div>
        </div>
    <?php endif ?>
<?php endforeach ?>
